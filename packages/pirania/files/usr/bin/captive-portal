#!/bin/sh
# requires nftables, liblucihttp0, liblucihttp-lua, uhttpd, uhttpd-mod-lua, uhttpd-mod-ubus

CACHE_DIR="/tmp/pirania/iplist"
NFT_BATCH_SIZE=200

IPV4_REGEX='^([0-9]{1,3}\.){3}[0-9]{1,3}(/([0-9]|[1-2][0-9]|3[0-2]))?$'
IPV6_REGEX='^[0-9A-Fa-f:]+(/([0-9]|[1-9][0-9]|1[01][0-9]|12[0-8]))?$'

ensure_cache_dir() {
	[ -d "$CACHE_DIR" ] || mkdir -p "$CACHE_DIR"
}

uci_get_list() {
	uci get "pirania.base_config.$1" 2>/dev/null | tr ' ' '\n' | sed '/^$/d'
}

filter_ip_list() {
	ip_version="$1"
	if [ "$ip_version" = "4" ]; then
		regex="$IPV4_REGEX"
	else
		regex="$IPV6_REGEX"
	fi

	sed -e 's/[[:space:]]*#.*$//' \
		-e 's/^[[:space:]]*//' \
		-e 's/[[:space:]]*$//' \
	| awk '{print $1}' \
	| grep -E "$regex" \
	| {
		if [ "$ip_version" = "6" ]; then
			grep -E ':' || true
		else
			cat
		fi
	}
}

resolve_list_source() {
	src="$1"
	case "$src" in
		http://*|https://*)
			ensure_cache_dir
			hash=$(printf '%s' "$src" | md5sum | awk '{print $1}')
			dest="$CACHE_DIR/$hash"
			if command -v uclient-fetch >/dev/null 2>&1; then
				uclient-fetch -O "$dest" "$src" >/dev/null 2>&1 || {
					[ -s "$dest" ] || return 1
				}
			else
				wget -qO "$dest" "$src" >/dev/null 2>&1 || {
					[ -s "$dest" ] || return 1
				}
			fi
			echo "$dest"
			;;
		file:*)
			echo "${src#file:}"
			;;
		*)
			echo "$src"
			;;
	esac
}

collect_ip_list() {
	list_option="$1"
	source_option="$2"
	ip_version="$3"
	output_file="$4"

	: > "$output_file"

	uci_get_list "$list_option" | filter_ip_list "$ip_version" >> "$output_file"

	for src in $(uci_get_list "$source_option") ; do
		file=$(resolve_list_source "$src") || continue
		[ -r "$file" ] || continue
		filter_ip_list "$ip_version" < "$file" >> "$output_file"
	done

	if [ -s "$output_file" ]; then
		sort -u "$output_file" -o "$output_file"
	fi
}

add_set_elements() {
	set_name="$1"
	input_file="$2"

	[ -s "$input_file" ] || return 0

	if ! awk -v set="$set_name" -v batch="$NFT_BATCH_SIZE" '
		NF {
			if (count == 0) {
				line = $1
			} else {
				line = line "," $1
			}
			count++
			if (count >= batch) {
				print "add element inet pirania " set " { " line " }"
				count = 0
				line = ""
			}
		}
		END {
			if (count > 0) {
				print "add element inet pirania " set " { " line " }"
			}
		}
	' "$input_file" | nft -f -; then
		while read -r element; do
			[ -n "$element" ] || continue
			nft add element inet pirania "$set_name" '{' "$element" '}' 2>/dev/null
		done < "$input_file"
	fi
}

clean_tables () {
	echo "Cleaning captive-portal rules if there's any"
	if nft list tables inet | grep -q "pirania"; then
		nft delete table inet pirania
	fi
	
}

set_nftables () { 
	echo "Apply captive-portal rules"
	# Detect wheter add or insert rules
	#append_nft_rules=$(uci get pirania.base_config.append_nft_rules 2> /dev/null)
	#if [ "$append_nft_rules" = "1" ] ; then
	#	op="add rule"
	#else
	#	op="insert rule"
	#fi

	# Create pirania tables	
	nft create table inet pirania
	# Create default tables and chains
	nft add table inet pirania
	nft add chain inet pirania prerouting { type nat hook prerouting priority 0 \; }
	nft add chain inet pirania input { type filter hook input priority 0 \; }
	nft add chain inet pirania forward { type filter hook forward priority 0 \; }

  	# Add mac-adress set
  	nft add set inet pirania pirania-auth-macs { type ether_addr\; }

	# Create ipv4 set on pirania table
	  nft add set inet pirania pirania-allowlist-ipv4 { type ipv4_addr \; flags interval \; comment \"allow ipv4 list\" \; }
	# Create ipv6 set on pirania table
	  nft add set inet pirania pirania-allowlist-ipv6 { type ipv6_addr \; flags interval \; comment \"allow ipv6 list\" \; }
	# Create ipv4 blocklist set on pirania table
	  nft add set inet pirania pirania-blocklist-ipv4 { type ipv4_addr \; flags interval \; comment \"block ipv4 list\" \; }
	# Create ipv6 blocklist set on pirania table
	  nft add set inet pirania pirania-blocklist-ipv6 { type ipv6_addr \; flags interval \; comment \"block ipv6 list\" \; }

	# Only accept packets from interfaces defined in catch_bridged_interfaces
	catch_interfaces=$(uci get pirania.base_config.catch_bridged_interfaces | sed 's/ /,/g')

	# blocklist should apply even to authorized macs
	nft add rule inet pirania prerouting ip daddr @pirania-blocklist-ipv4 counter log prefix "DROP-ipv4" drop
	nft add rule inet pirania prerouting ip6 daddr @pirania-blocklist-ipv6 counter log prefix "DROP-ipv6" drop

	# stop processing the chain for authorized macs and allowed ips (so they are accepted)
	nft add rule inet pirania prerouting ether saddr @pirania-auth-macs ct state new,established,related counter log prefix "ValidSMAC" accept
	nft add rule inet pirania prerouting ip daddr @pirania-allowlist-ipv4 ct state new,established,related counter log prefix "ACCEPT-ipv4" accept
	nft add rule inet pirania prerouting ip6 daddr @pirania-allowlist-ipv6 ct state new,established,related counter log prefix "ACCEPT-ipv6" accept

	# send DNS requests, that are not from valid ips or macs, to our own captive portal DNS at 59053
	nft add rule inet pirania prerouting meta l4proto udp udp dport 53 ether saddr != @pirania-auth-macs ct state new,established,related counter log prefix "SMACDNS"  redirect to :59053
	# redirect packets with dest port 80 to port 59080 of this host (the captive portal page).
	nft add rule inet pirania prerouting meta l4proto tcp tcp dport 80 ether saddr != @pirania-auth-macs ct state new,established,related counter log prefix "SMACHTTP"  redirect to :59080
	# drop packets with dest port 443 for unauthorized macs (block HTTPS) 
	nft add rule inet pirania prerouting meta l4proto tcp tcp dport 443 ether saddr != @pirania-auth-macs ct state new,established,related counter log prefix "SMACHTTPS" drop


	#nft add rule inet pirania prerouting meta l4proto tcp tcp dport 80 ip saddr @pirania-allowlist-ipv4 ct state new,established,related counter log prefix "IPv4HTTP" redirect to :59080
	#nft add rule inet pirania prerouting meta l4proto tcp tcp dport 80 ip6 saddr  @pirania-allowlist-ipv6 ct state new,established,related counter log prefix "IPV6HTTP" redirect to :59080

	#nft add rule inet pirania prerouting meta l4proto udp udp dport 53 ip saddr @pirania-allowlist-ipv4 ct state new,established,related counter redirect to :59053
	#nft add rule inet pirania prerouting meta l4proto udp udp dport 53 ip6 saddr @pirania-allowlist-ipv6 ct state new,established,related counter redirect to :59053
 

	# reject
	
	#nft add rule inet pirania prerouting drop
	#nft add rule inet pirania forward meta mark 0x11/0x11 counter reject with tcp reset
	#nft add rule inet pirania forward meta mark 0x11/0x11 counter reject

}

update_ipsets () {

  # Create tables and sets
  echo "Updating captive-portal rules"

  # Add authorized MAC addresses
  for mac in $(pirania_authorized_macs) ; do
    nft add element inet pirania pirania-auth-macs {$mac}
	echo "Adicionando enderecos:" $mac
  done

  # Update pirania allow/block lists for ipv4 and ipv6
  nft flush set inet pirania pirania-allowlist-ipv4
  nft flush set inet pirania pirania-allowlist-ipv6
  nft flush set inet pirania pirania-blocklist-ipv4
  nft flush set inet pirania pirania-blocklist-ipv6

  ensure_cache_dir

  allowlist_ipv4_file="$CACHE_DIR/allowlist_ipv4"
  allowlist_ipv6_file="$CACHE_DIR/allowlist_ipv6"
  blocklist_ipv4_file="$CACHE_DIR/blocklist_ipv4"
  blocklist_ipv6_file="$CACHE_DIR/blocklist_ipv6"

  collect_ip_list "allowlist_ipv4" "allowlist_ipv4_source" 4 "$allowlist_ipv4_file"
  collect_ip_list "allowlist_ipv6" "allowlist_ipv6_source" 6 "$allowlist_ipv6_file"
  collect_ip_list "blocklist_ipv4" "blocklist_ipv4_source" 4 "$blocklist_ipv4_file"
  collect_ip_list "blocklist_ipv6" "blocklist_ipv6_source" 6 "$blocklist_ipv6_file"

  add_set_elements "pirania-allowlist-ipv4" "$allowlist_ipv4_file"
  add_set_elements "pirania-allowlist-ipv6" "$allowlist_ipv6_file"
  add_set_elements "pirania-blocklist-ipv4" "$blocklist_ipv4_file"
  add_set_elements "pirania-blocklist-ipv6" "$blocklist_ipv6_file"
}

# check if captive-portal is enabled in /etc/config/pirania
enabled=$(uci get pirania.base_config.enabled)

if  [ "$1" = "start" ]; then
	echo "Running captive-portal"
	/etc/init.d/pirania-dnsmasq start
	/etc/init.d/pirania-uhttpd start
	clean_tables
	set_nftables
	update_ipsets
	exit
elif [ "$1" = "update" ] ; then
	echo "Captive-portal updating rules"
	update_ipsets
	exit
elif [ "$1" = "clean" ] || [ "$1" = "stop" ] ; then
	clean_tables
	exit
elif [ "$enabled" = "1" ]; then
	echo "Captive-portal already enabled, reloading rules"
	clean_tables
	set_nftables # required for "/etc/init.d/pirania start|restart|reload" if "uci get pirania.base_config.enabled" is "1"
	update_ipsets
	exit
elif [ "$1" = "enabled" ]; then
	uci set pirania.base_config.enabled='1'
	# i/o error in my device - check later
	#uci commit
	echo "Captive-portal is now enabled"
else
	echo "Pirania captive-portal is disabled. Try running captive-portal start"
	exit
fi
