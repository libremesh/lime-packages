#!/bin/sh
# requires nftables, liblucihttp0, liblucihttp-lua, uhttpd, uhttpd-mod-lua, uhttpd-mod-ubus


clean_tables () {
	echo "Cleaning captive-portal rules if there's any"
	if nft list tables inet | grep -q "pirania"; then
		nft delete table inet pirania
	fi
	
}

set_nftables () { 
    echo "Apply captive-portal rules"

    # Previous cleanup
    nft delete table inet pirania 2>/dev/null

    # Create the main table
    nft add table inet pirania

    # Chains
    nft add chain inet pirania prerouting \{ type nat hook prerouting priority -100\; \}
    nft add chain inet pirania forward \{ type filter hook forward priority 0\; policy accept\; \}

    # Sets
    nft add set inet pirania pirania-auth-macs \{ type ether_addr\; \}
    nft add set inet pirania pirania-auth-ips \{ type ipv4_addr\; \}
    nft add set inet pirania pirania-allowlist-ipv4 \{ type ipv4_addr\; flags interval\; comment \"allow ipv4 list\"\; \}
    nft add set inet pirania pirania-allowlist-ipv6 \{ type ipv6_addr\; flags interval\; comment \"allow ipv6 list\"\; \}

    # Allowlist
    nft add rule inet pirania prerouting ip daddr @pirania-allowlist-ipv4 accept
    nft add rule inet pirania prerouting ip6 daddr @pirania-allowlist-ipv6 accept

    # --- Forward rules ---
    # Allow traffic only if both IP and MAC are authorized
    nft add rule inet pirania forward ether saddr @pirania-auth-macs ip saddr @pirania-auth-ips accept

    # DNS always allowed for redirect
    nft add rule inet pirania forward udp dport 53 accept

    # --- NAT redirect for unauthorized traffic ---
    # HTTP redirect
    nft add rule inet pirania prerouting tcp dport 80 ip saddr != @pirania-auth-ips redirect to :59080
    nft add rule inet pirania prerouting tcp dport 80 ether saddr != @pirania-auth-macs redirect to :59080

    # DNS redirect
    nft add rule inet pirania prerouting udp dport 53 ip saddr != @pirania-auth-ips redirect to :59053
    nft add rule inet pirania prerouting udp dport 53 ether saddr != @pirania-auth-macs redirect to :59053

    # HTTPS block
    nft add rule inet pirania forward tcp dport 443 ip saddr != @pirania-auth-ips log prefix "BLOCK_HTTPS" drop
    nft add rule inet pirania forward tcp dport 443 ether saddr != @pirania-auth-macs log prefix "BLOCK_HTTPS" drop



    echo "Captive-portal rules applied successfully"
}

update_ipsets () {

  # Create tables and sets
  echo "Updating captive-portal rules"

  # Flush macs and ips auth lists to exclude invalidated addresses
  nft flush set inet pirania pirania-auth-macs
  nft flush set inet pirania pirania-auth-ips

  # Add authorized MAC addresses
  for mac in $(pirania_authorized_macs) ; do
    nft add element inet pirania pirania-auth-macs {$mac}
	echo "Adicionando enderecos:" $mac
  done
  # Add authorized IP addresses
  for ip in $(pirania_authorized_ips) ; do
    nft add element inet pirania pirania-auth-ips {$ip}
	echo "Adicionando enderecos:" $ip
  done

  # Update pirania-allowlist sets for ipv4 and ipv6
  nft flush set inet pirania pirania-allowlist-ipv4
  nft flush set inet pirania pirania-allowlist-ipv6
  
  # Add allowed ip/prefixes
  # Get values from allowlist_ipvX and add to pirania-allowlist-ipvX set
  ipv4allowlist=$(uci get pirania.base_config.allowlist_ipv4 | sed 's/ /,/g')
  nft add element inet pirania pirania-allowlist-ipv4 {$ipv4allowlist}

  ipv6allowlist=$(uci get pirania.base_config.allowlist_ipv6 | sed 's/ /,/g')
  nft add element inet pirania pirania-allowlist-ipv6 {$ipv6allowlist}
}

# check if captive-portal is enabled in /etc/config/pirania
enabled=$(uci get pirania.base_config.enabled)

if  [ "$1" = "start" ]; then
	echo "Running captive-portal"
	/etc/init.d/pirania-dnsmasq start
	/etc/init.d/pirania-uhttpd start
	clean_tables
	set_nftables
	update_ipsets
	exit
elif [ "$1" = "update" ] ; then
	echo "Captive-portal updating rules"
	update_ipsets
	exit
elif [ "$1" = "clean" ] || [ "$1" = "stop" ] ; then
	clean_tables
	exit
elif [ "$enabled" = "1" ]; then
	echo "Captive-portal already enabled, reloading rules"
	clean_tables
	set_nftables # required for "/etc/init.d/pirania start|restart|reload" if "uci get pirania.base_config.enabled" is "1"
	update_ipsets
	exit
elif [ "$1" = "enabled" ]; then
	uci set pirania.base_config.enabled='1'
	# i/o error in my device - check later
	#uci commit
	echo "Captive-portal is now enabled"
else
	echo "Pirania captive-portal is disabled. Try running captive-portal start"
	exit
fi
