#!/usr/bin/lua
--! SPDX-License-Identifier: AGPL-3.0-only
--! 
--! Copyright (C) 2019  Gioacchino Mazzurco <gio@altermundi.net>
--! Copyright (C) 2019  Nicolas Echaniz <nicoechaniz@altermundi.net>

local libuci = require("uci")

-- Function to get HTTP headers using netcat
local function http_head_request(url)
    -- Parse URL to extract host and path
    local host = url:gsub("^https?://", ""):gsub("/.*", "")
    local port = 80
    
    -- Check if port is specified in host
    if host:match(":") then
        host, port = host:match("([^:]+):(%d+)")
        port = tonumber(port)
    end
    
    -- Build netcat command with HTTP HEAD request
    local cmd = string.format(
        "printf 'HEAD / HTTP/1.1\\r\\nHost: %s\\r\\nConnection: close\\r\\n\\r\\n' | nc %s %d 2>/dev/null",
        host, host, port
    )
    
    local handle = io.popen(cmd)
    if not handle then
        return nil
    end
    
    local response = handle:read("*a")
    local success = handle:close()
    
    if not success or response == "" then
        return nil
    end
    
    -- Parse headers into a table
    local headers = {}
    for line in response:gmatch("[^\r\n]+") do
        local key, value = line:match("^([^:]+):%s*(.+)$")
        if key and value then
            headers[key] = value
        end
    end
    
    return { headers = headers }
end

local config = libuci:cursor()
local url = config:get("check-date", "http", "server")
url = url or { "http://openwrt.org" }
math.randomseed(os.time())
url = url[math.random(#url)]
local resetDate = config:get("check-date", "system", "reset_date") or false
local restartSysntpd = config:get("check-date", "system", "restart_sysntpd")
restartSysntpd = (restartSysntpd == nil) or restartSysntpd
config = nil

local localCurrDate = assert(io.popen("date --utc -Iminutes", 'r'):read())
local lFormat="(%d+)-(%d+)-(%d+)T(%d+):(%d+)"
local lYear, lMonth, lDay, lHour, lMin = localCurrDate:match(lFormat)

local response = http_head_request(url)

if not response then
    print(arg[0], "HTTP request failed", url)
    os.exit(42)
elseif not response.headers or not response.headers['Date'] then
    print(arg[0], "The server cannot be reached or Date header missing", url)
    os.exit(43)
end

local s = response.headers['Date']
local p="%a+, (%d+) (%a+) (%d+) (%d+):(%d+):(%d+) GMT"
local day, month, year, hour, min, sec = s:match(p)

if not day then
    print(arg[0], "Could not parse Date header:", s)
    os.exit(44)
end

local MON = { Jan="01", Feb="02", Mar="03", Apr="04", May="05", Jun="06", Jul="07", Aug="08", Sep="09", Oct="10", Nov="11", Dec="12"}
month = MON[month]

local skewDetected = false

local lTdate = { lYear, lMonth, lDay, lHour }
local rTdate = { year,  month,  day,  hour }

for i=1,#lTdate do
	if(lTdate[i] ~= rTdate[i]) then
		skewDetected = true
		break
	end
end

skewDetected = skewDetected or (math.abs(lMin - min) > 13)

if(skewDetected) then
	local currDate = string.format(
		"%s.%s.%s-%s:%s:%s", lYear, lMonth, lDay, lHour, lMin, "XX" )
	local newDate = string.format(
		"%s.%s.%s-%s:%s:%s", year, month, day, hour, min, sec )

	print( arg[0].." Too far away clock skew detected "..
	       " local "..currDate.." "..url.." "..newDate )

	if resetDate then
		local newDate = string.format(
			"%s.%s.%s-%s:%s:%s", year, month, day, hour, min, sec )
		os.execute("date --utc --set "..newDate)
	end
	if restartSysntpd then os.execute("/etc/init.d/sysntpd restart") end
end
