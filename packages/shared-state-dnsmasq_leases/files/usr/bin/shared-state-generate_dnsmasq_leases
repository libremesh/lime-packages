#!/usr/bin/lua
--! SPDX-License-Identifier: AGPL-3.0-or-later
--!
--! LibreMesh
--! Copyright (C) 2019  Gioacchino Mazzurco <gio@altermundi.net>

local JSON = require("luci.jsonc")

local outputTable = {}
local localHostname = io.input("/proc/sys/kernel/hostname"):read("*line")

for key,value in pairs(JSON.parse(io.stdin:read("*all"))) do
	if value.data and value.data.mac and value.author ~= localHostname then
		local hwaddr = value.data.mac
		local ipaddr = key
		if ipaddr:find(":") then ipaddr = "[" .. ipaddr .. "]" end
		ipaddr = ","..ipaddr

	table.insert(outputTable, hwaddr..ipaddr)
	end
end

local outFile = io.open("/tmp/dhcp.hosts_remote", "w")
outFile:write(table.concat(outputTable,"\n").."\n")
outFile:close()
outFile = nil

os.execute("killall -HUP dnsmasq 2>/dev/null")
