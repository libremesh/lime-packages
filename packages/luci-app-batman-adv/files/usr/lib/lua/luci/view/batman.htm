<%#
LuCI - Lua Configuration Interface
Copyright 2012 Jo-Philipp Wich <xm@subsignal.org>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id$

-%>

<%
	local cur_vm = luci.sys.exec("batctl vm"):trim()
	local cur_gw = luci.sys.exec("batctl gw"):match("^(%S+)")
	local cur_gv = luci.sys.exec("batctl gw"):match("%(.+: (%S+)%)");
%>

<%+header%>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">//<![CDATA[
	function vis_apply(field)
	{
		document.getElementById('vis_form').style.display = 'none';
		document.getElementById('vis_apply').style.display = '';

		XHR.get('<%=luci.dispatcher.build_url("batman/vis")%>/'+field.value, null,
			function() {
				document.getElementById('vis_form').style.display = '';
				document.getElementById('vis_apply').style.display = 'none';
				document.getElementById('vis_form_dl').style.display =
					(field.value == 'server') ? '' : 'none';
			});
	}

	function gw_apply(field)
	{
		var mode, val;

		if (field.type == 'radio') {
			val  = '';
			mode = field.value;
		}
		else {
			val  = field.value;
			mode = document.getElementById('gw_gateway').checked ? 'server' : 'client';
		}

		document.getElementById('gw_apply').style.display = '';
		document.getElementById('gw_form').style.display = 'none';
		document.getElementById('gw_form_val').parentNode.style.display = (mode != 'off') ? '' : 'none';

		XHR.get('<%=luci.dispatcher.build_url("batman/gw")%>/'+mode+'/'+encodeURIComponent(val), null,
			function(x, info) {
				document.getElementById('gw_form').style.display = '';
				document.getElementById('gw_apply').style.display = 'none';
				document.getElementById('gw_form_val').value = info;
			});
	}


	XHR.poll(5, '<%=luci.dispatcher.build_url("batman/json")%>', null,
		function(x, info)
		{
			var t;

			var og = info.originators;
			var gw = info.gateways;

			if (!!(t = document.getElementById('originator_table')))
			{
				/* clear all rows */
				while (t.rows.length > 1)
					t.rows[0].parentNode.deleteRow(1);

				og.sort(function(a, b) { return a[0] > b[0] });

				for (var i = 0; i < og.length; i++)
				{
					var tr = t.rows[0].parentNode.insertRow(-1);
						tr.className = 'cbi-section-table-row cbi-rowstyle-' + (1 + (i % 2));

					var icon;
					if (og[i][2] < 64)
						icon = "<%=resource%>/icons/signal-0-25.png";
					else if (og[i][2] < 128)
						icon = "<%=resource%>/icons/signal-25-50.png";
					else if (og[i][2] < 192)
						icon = "<%=resource%>/icons/signal-50-75.png";
					else
						icon = "<%=resource%>/icons/signal-75-100.png";

					tr.insertCell(-1).innerHTML = String.format(
						'<img src="%s" title="<%:Quality%>: %d / 255" style="vertical-align:middle" /> %d/255',
						icon, og[i][2], og[i][2]
					);

					tr.insertCell(-1).innerHTML = og[i][0];
					tr.insertCell(-1).innerHTML = String.format('%dms', og[i][1]);
				}

				if (t.rows.length == 1)
				{
					var tr = t.rows[0].parentNode.insertRow(-1);
						tr.className = 'cbi-section-table-row';

					var td = tr.insertCell(-1);
						td.colSpan = 3;
						td.innerHTML = '<br /><em><%:There are no active neighbors%></em>';
				}
			}

			if (!!(t = document.getElementById('gateway_table')))
			{
				/* clear all rows */
				while (t.rows.length > 1)
					t.rows[0].parentNode.deleteRow(1);

				gw.sort(function(a, b) { return a[0] > b[0] });

				for (var i = 0; i < gw.length; i++)
				{
					var tr = t.rows[0].parentNode.insertRow(-1);
						tr.className = 'cbi-section-table-row cbi-rowstyle-' + (1 + (i % 2));

					tr.insertCell(-1).innerHTML = gw[i][0]
						? String.format('<strong>%s (active)</strong>', gw[i][1])
						: gw[i][1];

					tr.insertCell(-1).innerHTML = gw[i][6];
					tr.insertCell(-1).innerHTML = String.format('%dms', gw[i][2]);
					tr.insertCell(-1).innerHTML = gw[i][4];
					tr.insertCell(-1).innerHTML = gw[i][3];
				}

				if (t.rows.length == 1)
				{
					var tr = t.rows[0].parentNode.insertRow(-1);
						tr.className = 'cbi-section-table-row';

					var td = tr.insertCell(-1);
						td.colSpan = 3;
						td.innerHTML = '<br /><em><%:There are no active mesh gateways%></em>';
				}
			}
		}
	);
//]]></script>

<h2><a id="content" name="content"><%:B.A.T.M.A.N. Status%></a></h2>

<fieldset class="cbi-section">
	<legend><%:Visualization Server%></legend>
	<div id="vis_form">
		<input type="radio" name="vis" value="client" id="vis_client" onchange="vis_apply(this)"<%=ifattr(cur_vm ~= "server", "checked", "checked")%> />
		<label for="vis_client"><%:Act as client%></label>
		&#160; &#160;

		<input type="radio" name="vis" value="server" id="vis_server" onchange="vis_apply(this)"<%=ifattr(cur_vm == "server", "checked", "checked")%> />
		<label for="vis_server"><%:Act as server%></label>

		<span id="vis_form_dl"<%=ifattr(cur_vm ~= "server", "style", "display:none")%>>
			- <a href="<%=luci.dispatcher.build_url("batman/graph")%>"><%:View Topology%></a>
			- <a href="<%=luci.dispatcher.build_url("batman/topo")%>"><%:Download Topology%></a>
		</span>
	</div>
	<div id="vis_apply" style="display:none">
		<em><%:Applying change...%></em>
	</div>
</fieldset>

<fieldset class="cbi-section">
	<legend><%:Gateway Selection%></legend>
	<div id="gw_form">
		<input type="radio" name="gw" value="off" id="gw_off" onchange="gw_apply(this)"<%=ifattr(cur_gw == "off", "checked", "checked")%> />
		<label for="gw_off"><%:Turn off%></label>
		&#160; &#160;

		<input type="radio" name="gw" value="client" id="gw_client" onchange="gw_apply(this)"<%=ifattr(cur_gw == "client", "checked", "checked")%> />
		<label for="gw_client"><%:Act as client%></label>
		&#160; &#160;

		<input type="radio" name="gw" value="server" id="gw_gateway" onchange="gw_apply(this)"<%=ifattr(cur_gw == "server", "checked", "checked")%> />
		<label for="gw_gateway"><%:Act as gateway%></label>
		&#160; &#160;

		<span<%=ifattr(cur_gw == "off", "style", "display:none")%>>
			<label for="gw_form_val"><%:Bandwidth/Class%>:</label>
			<input type="text" id="gw_form_val" value="<%=cur_gv%>" onfocus="this.select()" onkeypress="if (event.which == 13 || event.keyCode == 13) { gw_apply(this); this.blur() }" />
		</span>
	</div>
	<div id="gw_apply" style="display:none">
		<em><%:Applying change...%></em>
	</div>
</fieldset>

<fieldset class="cbi-section">
	<legend><%:Originators%></legend>
	<table class="cbi-section-table" id="originator_table">
		<tr class="cbi-section-table-titles">
			<th class="cbi-section-table-cell">&#160;</th>
			<th class="cbi-section-table-cell"><%:MAC-Address%></th>
			<th class="cbi-section-table-cell"><%:Last Seen%></th>
		</tr>
		<tr class="cbi-section-table-row">
			<td colspan="3"><em><br /><%:Collecting data...%></em></td>
		</tr>
	</table>
</fieldset>

<fieldset class="cbi-section">
	<legend><%:Gateways%></legend>
	<table class="cbi-section-table" id="gateway_table">
		<tr class="cbi-section-table-titles">
			<th class="cbi-section-table-cell"><%:MAC-Address%></th>
			<th class="cbi-section-table-cell"><%:Speed%></th>
			<th class="cbi-section-table-cell"><%:Last Seen%></th>
			<th class="cbi-section-table-cell"><%:Interface%></th>
			<th class="cbi-section-table-cell"><%:Next Hop%></th>
		</tr>
		<tr class="cbi-section-table-row">
			<td colspan="3"><em><br /><%:Collecting data...%></em></td>
		</tr>
	</table>
</fieldset>

<%+footer%>
