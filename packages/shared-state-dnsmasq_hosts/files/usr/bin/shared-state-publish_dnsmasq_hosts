#!/usr/bin/lua
--! SPDX-License-Identifier: AGPL-3.0-or-later
--!
--! LibreMesh
--! Copyright (C) 2019  Gioacchino Mazzurco <gio@altermundi.net>

local JSON = require("luci.jsonc")

local recordsTable = {}

for line in io.input("/etc/hosts"):lines() do
	if line ~= "" and
		not line:match("^%s*$") and
		not line:match("^%s*127\.") and
		not line:match("^%s*::1%s") and
		not line:match("^%s*ff02::1%s") and
		not line:match("^%s*ff02::2%s") then
		recordsTable[line] = true
	end
end

io.popen("shared-state insert dnsmasq-hosts", "w"):write(JSON.stringify(recordsTable))
