#!/usr/bin/lua
--! SPDX-License-Identifier: AGPL-3.0-only
--!
--! Copyright (C) 2019  Gioacchino Mazzurco <gio@altermundi.net>

local JSON = require("luci.jsonc")

local hostname = nil
local babelid = nil

local cStdout = io.popen("echo | nc ::1 30003", "r")
for line in cStdout:lines() do
	hostname = hostname or line:match("^host (.+)$")
	babelid = babelid or line:match("^my%-id (.+)$")
end
cStdout:close()

local babHostTable = {}
babHostTable[babelid] = hostname

io.popen("shared-state insert babeld-hosts", "w"):write(
	JSON.stringify(babHostTable) )
