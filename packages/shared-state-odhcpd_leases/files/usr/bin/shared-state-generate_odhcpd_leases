#!/usr/bin/lua

local JSON = require('luci.jsonc')

local final_path = '/tmp/ethers.mesh'
local temp_path = final_path .. '.new' 

local leases = JSON.parse(io.stdin:read('*a')) or {}

local myself_handle = io.open('/proc/sys/kernel/hostname')
local myself = myself_handle:read('*l')
myself_handle:close()

local f = io.open(temp_path, 'w')

for ip, data in pairs(leases) do

  if data and data.mData and data.mData.mac and data.mAuthor ~= myself then
    f:write(string.format('%s %s\n', data.mData.mac, ip)) -- Format: MAC IP
  end
end
f:close() 
os.execute('mv "' .. temp_path .. '" "' .. final_path .. '"')

os.execute('/etc/init.d/odhcpd reload')
